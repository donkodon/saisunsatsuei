<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Permissions-Policy" content="camera=(self)">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="measure_master">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>measure_master</title>
  <link rel="manifest" href="manifest.json">

  <!-- ZXing Barcode Scanner Library for Web (軽量・高速) -->
  <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
  
  <!-- Html5-QRCode Library for Web (代替用) -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  
  <!-- Firebase JS SDK v11.9.1 (ESM) - firebase_core_web が期待するwindow変数に事前設定 -->
  <!-- flutter_bootstrap.js の前に同期的に完了させる -->
  <script>
    // firebase_core_web の injectSrcScript と同じ方式で事前ロード
    // window.firebase_core が存在すれば _initializeCore() はスキップする
    const _fbVersion = '11.9.1';
    const _fbBaseUrl = 'https://www.gstatic.com/firebasejs/' + _fbVersion;
    
    // window変数名のマッピング: service名 → window変数名
    const _fbModules = {
      'app': 'firebase_core',
      'auth': 'firebase_auth', 
      'firestore': 'firebase_firestore'
    };
    
    // Promise を作成して flutter_bootstrap.js のロード前に完了を保証
    window._firebaseLoadPromise = (async function() {
      for (const [mod, windowVar] of Object.entries(_fbModules)) {
        const url = _fbBaseUrl + '/firebase-' + mod + '.js';
        try {
          const m = await import(url);
          window[windowVar] = m;
          console.log('✅ Firebase ' + mod + ' pre-loaded → window.' + windowVar);
        } catch (e) {
          console.error('❌ Failed to pre-load Firebase ' + mod + ':', e);
        }
      }
    })();
  </script>
  
  <style>
    /* バーコードスキャナーのスタイル */
    #html5-qrcode-reader {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }
    
    #html5-qrcode-reader video {
      border-radius: 12px;
    }
  </style>
</head>
<body>
  <!-- Firebase SDKのロード完了を待ってからFlutterを起動 -->
  <script>
    (async function() {
      // Firebase SDKの事前ロード完了を待つ
      if (window._firebaseLoadPromise) {
        await window._firebaseLoadPromise;
        console.log('✅ All Firebase modules ready, starting Flutter...');
      }
      // flutter_bootstrap.js を動的にロード
      const script = document.createElement('script');
      script.src = 'flutter_bootstrap.js';
      document.body.appendChild(script);
    })();
  </script>
</body>
</html>
